"use strict";function alert_log(obj,name){if(obj){logger.info(name+" Ok.")}else{logger.fatal(name+" NG.")}}var express=require("express");var emitter=require("events").EventEmitter;var fs=require("fs");var text=fs.readFileSync("config/config.json","utf-8");var config=JSON.parse(text);var log4js=require("log4js");log4js.configure("config/logs.json");var logger=log4js.getLogger("request");logger.setLevel(config.loglevel);alert_log(express,"express");alert_log(emitter,"emitter");var mongoose=require("mongoose");alert_log(mongoose,"mongoose");var Grid=require("gridfs-stream");alert_log(Grid,"Grid");var _=require("lodash");alert_log(_,"lodash");alert_log(fs,"fs");alert_log(config,"config");config.dbaddress=process.env.DB_PORT_27017_TCP_ADDR||config.dbaddress;if(config.dbaddress){logger.info("config.dbaddress : "+config.dbaddress)}else{logger.fatal("config.dbaddress NG.")}var PatientModel=require("./../model/patient");alert_log(PatientModel,"PatientModel");var AccountModel=require("./../model/account");alert_log(AccountModel,"AccountModel");var ViewModel=require("./../model/view");alert_log(ViewModel,"ViewModel");var FileModel=require("./../model/file");alert_log(FileModel,"FileModel");var ToHtml=require("./lib/tohtml");alert_log(ToHtml,"ToHtml");var passport=require("passport");alert_log(passport,"passport");var router=express.Router();var Settings=require("./settings");alert_log(log4js,"log4js");var result=require("./lib/result");alert_log(log4js,"log4js");var AccountController=require("./controllers/account_controller");alert_log(AccountController,"AccountController");var PatientController=require("./controllers/patient_controller");alert_log(log4js,"log4js");var ViewController=require("./controllers/view_controller");alert_log(ViewController,"ViewController");var FileController=require("./controllers/file_controller");alert_log(FileController,"FileController");var PdfController=require("./controllers/pdf_controller");alert_log(PdfController,"PdfController");var ConfigController=require("./controllers/config_controller");alert_log(ConfigController,"ConfigController");var Wrapper=require("./lib/wrapper");var wrapper=new Wrapper;alert_log(wrapper,"wrapper");var account_controller=new AccountController;alert_log(account_controller,"account_controller");var partient_controller=new PatientController;alert_log(partient_controller,"partient_controller");var view_controller=new ViewController;alert_log(view_controller,"view_controller");var file_controller=new FileController;alert_log(file_controller,"file_controller");var pdf_controller=new PdfController;alert_log(pdf_controller,"pdf_controller");var config_controller=new ConfigController;alert_log(config_controller,"config_controller");logger.info("Index.js Start.");module.exports=router;try{_.each(config.initusers,function(user){wrapper.FindOne(null,1e3,AccountModel,{username:user.user},function(res,account){if(!account){logger.trace("Creating init user");AccountModel.register(new AccountModel({username:user.user,type:user.type}),user.password,function(error,account){if(!error){logger.trace("Created")}else{logger.trace("Error")}})}})});var connection="mongodb://"+config.dbuser+":"+config.dbpassword+"@"+config.dbaddress+"/"+config.dbname;var conn=mongoose.createConnection(connection);if(conn){conn.once("open",function(error){if(!error){var gfs=Grid(conn.db,mongoose.mongo);if(gfs){conn.db.collection("fs.files",function(error,collection){if(!error){if(collection){collection.findOne({filename:"schema1.png"},function(error,item){if(!error){if(!item){logger.trace("Creating init schema");var readstream=fs.createReadStream("public/images/schema1.png");var writestream=gfs.createWriteStream({filename:"schema1.png"});if(writestream){readstream.pipe(writestream);writestream.on("close",function(file){conn.db.close();logger.trace("Created")})}else{logger.error("Created schema writestream")}}}else{logger.error("Created schema find")}})}else{logger.error("Created schema connection")}}else{logger.error("Created schema collection")}})}else{logger.error("Created schema gfs")}}else{logger.error("Created schema open")}})}ViewModel.count({},function(counterror,count){if(!counterror){if(count<=0){logger.trace("Creating init View");var ev=new emitter;ev.on("view",function(data){var view=new ViewModel;view.Name=data.Name;view.Group=data.Group;view.Pages=data.Pages;view.save(function(error){logger.trace("Created init View")})});var config=new Settings;var views=config.initView.Views;_.each(views,function(data,index){ev.emit("view",data)})}}else{logger.error("count open")}})}catch(e){logger.fatal("init")}router.get("/",function(req,res){res.render("index",{development:config.state==="development"})});router.get("/document/:id",function(req,res,next){PatientModel.findById(req.params.id,function(finderror,patient){if(!finderror){if(patient){res.render("document/index",{patient:patient})}else{logger.error("/document/:id 1");next()}}else{logger.error("/document/:id 2");next()}})});router.get("/partials/logo",function(req,res,next){res.render("partials/logo")});router.get("/backend/",function(req,res){res.render("backend/index",{development:config.state==="development"})});router.get("/backend/partials/patient/start",function(req,res){res.render("backend/partials/patient/start")});router.get("/backend/partials/patient/patients",function(req,res){res.render("backend/partials/patient/patients")});router.get("/backend/partials/patient/description/:id",function(req,res,next){var id=req.params.id;PatientModel.findById(id,function(error,patient){if(!error){if(patient){res.render("backend/partials/patient/description",{patient:patient})}else{logger.error("/backend/partials/patient/description/:id 1");next()}}else{logger.error("/backend/partials/patient/description/:id 2");next()}})});router.get("/front/dialog/confirmdialog",function(req,res){res.render("front/dialog/confirmdialog")});router.get("/backend/partials/patient/patientacceptdialog",function(req,res){res.render("backend/partials/patient/patientacceptdialog")});router.get("/backend/partials/patient/sheet",function(req,res){res.render("backend/partials/patient/sheet")});router.get("/backend/partials/patient/totalsheet",function(req,res){res.render("backend/partials/patient/totalsheet")});router.get("/backend/partials/patient/configsheet",function(req,res){res.render("backend/partials/patient/configsheet")});router.get("/backend/partials/account/accounts",function(req,res){res.render("backend/partials/account/accounts")});router.get("/backend/partials/account/logindialog",function(req,res){res.render("backend/partials/account/logindialog")});router.get("/backend/partials/account/registerdialog",function(req,res){res.render("backend/partials/account/registerdialog")});router.get("/backend/partials/account/deletedialog",function(req,res){res.render("backend/partials/account/deletedialog")});router.get("/backend/partials/account/accountdialog",function(req,res){res.render("backend/partials/account/accountdialog")});router.get("/backend/partials/edit/departmentcreatedialog",function(req,res){res.render("backend/partials/edit/departmentcreatedialog")});router.get("/backend/partials/edit/departmentcopydialog",function(req,res){res.render("backend/partials/edit/departmentcopydialog")});router.get("/backend/partials/edit/departmentdeletedialog",function(req,res){res.render("backend/partials/edit/departmentdeletedialog")});router.get("/backend/partials/edit/pagecreatedialog",function(req,res){res.render("backend/partials/edit/pagecreatedialog")});router.get("/backend/partials/edit/pagedeletedialog",function(req,res){res.render("backend/partials/edit/pagedeletedialog")});router.get("/backend/partials/edit/item/text/textcreatedialog",function(req,res){res.render("backend/partials/edit/item/text/textcreatedialog")});router.get("/backend/partials/edit/item/check/checkcreatedialog",function(req,res){res.render("backend/partials/edit/item/check/checkcreatedialog")});router.get("/backend/partials/edit/item/select/selectcreatedialog",function(req,res){res.render("backend/partials/edit/item/select/selectcreatedialog")});router.get("/backend/partials/edit/item/numeric/numericcreatedialog",function(req,res){res.render("backend/partials/edit/item/numeric/numericcreatedialog")});router.get("/backend/partials/edit/item/picture/picturecreatedialog",function(req,res){res.render("backend/partials/edit/item/picture/picturecreatedialog")});router.get("/backend/partials/edit/item/button/buttoncreatedialog",function(req,res){res.render("backend/partials/edit/item/button/buttoncreatedialog")});router.get("/backend/partials/edit/item/text/textupdatedialog",function(req,res){res.render("backend/partials/edit/item/text/textupdatedialog")});router.get("/backend/partials/edit/item/check/checkupdatedialog",function(req,res){res.render("backend/partials/edit/item/check/checkupdatedialog")});router.get("/backend/partials/edit/item/select/selectupdatedialog",function(req,res){res.render("backend/partials/edit/item/select/selectupdatedialog")});router.get("/backend/partials/edit/item/numeric/numericupdatedialog",function(req,res){res.render("backend/partials/edit/item/numeric/numericupdatedialog")});router.get("/backend/partials/edit/item/picture/pictureupdatedialog",function(req,res){res.render("backend/partials/edit/item/picture/pictureupdatedialog")});router.get("/backend/partials/edit/item/button/buttonupdatedialog",function(req,res){res.render("backend/partials/edit/item/button/buttonupdatedialog")});router.get("/backend/partials/edit/item/text/textdeletedialog",function(req,res){res.render("backend/partials/edit/item/text/textdeletedialog")});router.get("/backend/partials/edit/item/check/checkdeletedialog",function(req,res){res.render("backend/partials/edit/item/check/checkdeletedialog")});router.get("/backend/partials/edit/item/select/selectdeletedialog",function(req,res){res.render("backend/partials/edit/item/select/selectdeletedialog")});router.get("/backend/partials/edit/item/numeric/numericdeletedialog",function(req,res){res.render("backend/partials/edit/item/numeric/numericdeletedialog")});router.get("/backend/partials/edit/item/picture/picturedeletedialog",function(req,res){res.render("backend/partials/edit/item/picture/picturedeletedialog")});router.get("/backend/partials/edit/item/button/buttondeletedialog",function(req,res){res.render("backend/partials/edit/item/button/buttondeletedialog")});router.get("/backend/partials/edit/departments",function(req,res){res.render("backend/partials/edit/departments")});router.get("/backend/partials/edit/department",function(req,res){res.render("backend/partials/edit/department")});router.get("/backend/partials/edit/page",function(req,res){res.render("backend/partials/edit/page")});router.get("/backend/partials/edit/files",function(req,res){res.render("backend/partials/edit/files")});router.get("/backend/partials/controll/notification",function(req,res){res.render("backend/partials/controll/notification")});router.get("/backend/partials/controll/panel",function(req,res){res.render("backend/partials/controll/panel")});router.get("/backend/partials/error",function(req,res){res.render("backend/partials/error")});router.get("/front/",function(req,res){res.render("front/index",{development:config.state==="development"})});router.get("/front/partials/browseS",function(req,res){res.render("front/partials/browseS")});router.get("/front/partials/browse",function(req,res){res.render("front/partials/browse")});router.get("/front/partials/write",function(req,res){res.render("front/partials/write")});router.post("/patient/accept",partient_controller.post_patient_accept);router.get("/patient/:id",partient_controller.get_patient_id);router.put("/patient/:id",partient_controller.put_patient_id);router.delete("/patient/:id",partient_controller.delete_patient_id);router.get("/patient/query/:query",partient_controller.get_patient_query_query);router.get("/patient/count/:query",partient_controller.get_patient_count_query);router.get("/patient/status/:id",partient_controller.get_patient_status_id);router.put("/patient/status/:id",partient_controller.put_patient_status_id);router.put("/patient/information/:id",partient_controller.put_patient_information_id);router.get("/api/:key/patient/query/:query",partient_controller.get_api_key_patient_query_query);router.post("/account/create",account_controller.post_account_create);router.post("/account/logout",account_controller.post_account_logout);router.post("/account/login",account_controller.post_account_login);router.get("/account/:id",account_controller.get_account_id);router.put("/account/:id",account_controller.put_account_id);router.delete("/account/:id",account_controller.delete_account_id);router.get("/account/query/:query",account_controller.get_account_query_query);router.put("/account/password/:id",account_controller.get_account_password_id);router.post("/view",view_controller.post_view);router.post("/view/create",view_controller.post_view_create);router.get("/view/:id",view_controller.get_view_id);router.put("/view/:id",view_controller.put_view_id);router.delete("/view/:id",view_controller.delete_view_id);router.get("/view/query/:query",view_controller.get_view_query_query);router.get("/file/:name",file_controller.get_file_name);router.post("/file/:name",file_controller.post_file_name);router.put("/file/:name",file_controller.put_file_name);router.delete("/file/:name",file_controller.delete_file_name);router.get("/file/query/:query",file_controller.get_file_query_query);router.get("/pdf/:id",pdf_controller.get_pdf_id);router.get("/config",config_controller.get_config);router.put("/config",config_controller.put_config);router.get("/front/partials/browse2/:name",function(req,res){var tohtml=new ToHtml;wrapper.GetView(req.params.name,function(view){var hoge=tohtml.render(view.Data.content);res.send(tohtml.render(view.Data.content))},function(){res.send(JSON.stringify(new result(10,"view get",{})))},function(message,error){res.send(JSON.stringify(new result(100,"view get",error)))})});router.get("/json",function(req,res,next){var tohtml=new ToHtml;var data={name:"page1",content:{}};data.content={tag:"md-content",style:"page.style",childelements:[{tag:"ng-form",name:"validate",childelements:[{tag:"div",childelements:[{tag:"md-card",childelements:[{tag:"md-card-content",childelements:[{tag:"md-button","class":"md-raised md-primary",style:"height:30px;width:10px;top:130px;left:200px;z-index:1;position: absolute",childelements:[{value:"aaaaaaa"}]},{tag:"md-checkbox","ng-model":"checkbox",childelements:[{value:"zz"}]},{tag:"md-input-container","class":"md-raised md-warn",childelements:[{tag:"label",childelements:[{value:"AAA"}]},{tag:"input",name:"input","ng-model":"input","md-maxlength":"30",required:"true"},{tag:"div","ng-messages":"validate.input.$error",childelements:[{tag:"div","ng-message":"md-maxlength",childelements:[{value:"max"}]},{tag:"div","ng-message":"required",childelements:[{value:"req"}]}]}]},{tag:"md-switch","class":"md-fab md-accent","ng-model":"switch",childelements:[{value:"zz"}]},{tag:"md-radio-group","class":"md-raised md-primary","ng-model":"radio",childelements:[{tag:"md-radio-button",value:"true",childelements:[{value:"AAA"}]},{tag:"md-radio-button",value:"false",childelements:[{value:"a"}]}]}]}]}]}]}]};var head="<!DOCTYPE html>"+'<html lang="ja">'+"<head>"+'<meta charset="utf-8">'+'<meta name="format-detection" content="telephone=no">'+'<meta name="msapplication-tap-highlight" content="no">'+'<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height">'+"<title>wmonsin</title>"+'<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">'+'<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">'+'<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">'+'<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">'+'<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">'+'<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">'+'<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">'+'<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">'+'<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">'+'<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">'+'<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">'+'<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">'+'<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">'+'<link rel="manifest" href="/favicons/manifest.json">'+'<meta name="msapplication-TileColor" content="#da532c">'+'<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">'+'<meta name="theme-color" content="#ffffff">'+'<link rel="stylesheet" type="text/css" href="/bower_components/angular-material/angular-material.min.css">'+'<link rel="stylesheet" type="text/css" href="/stylesheets/style.css">'+"</head>"+'<body layout="column" ng-app="PatientsApplication" style="background-color: #A0A0FF;">';var tail="</body>"+"</html>"+'<script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>'+'<script type="text/javascript" src="/socket.io/socket.io.js"></script>'+'<script type="text/javascript" src="/bower_components/hammerjs/hammer.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular/angular.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-ui-router/release/angular-ui-router.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-animate/angular-animate.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-aria/angular-aria.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-material/angular-material.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-messages/angular-messages.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-resource/angular-resource.min.js"></script>'+'<script type="text/javascript" src="/bower_components/angular-material-icons/angular-material-icons.min.js"></script>'+'<script type="text/javascript" src="/bower_components/lodash/lodash.min.js"></script>'+'<script type="text/javascript" src="/bower_components/fabric/dist/fabric.min.js"></script>'+'<script type="text/javascript" src="/front/javascripts/PatientsApplication.min.js"></script>'+'<script type="text/javascript" src="/front/javascripts/PatientsControllers.min.js"></script>'+'<script type="text/javascript" src="/javascripts/TopControllers.min.js"></script>';res.send(head+tohtml.render(data.content)+tail)});logger.info("-----------------------Start---------------------");